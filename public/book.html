<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Principito - Libro Interactivo</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/book-styles.css">
</head>
<body>
  <!-- Capa do livro -->
  <div id="bookCover" class="book-cover">
    <div class="cover-content">
      <div class="custom-cover-container" id="customCoverContainer" style="display: none;">
        <img id="customCoverImage" class="custom-cover-image" alt="El Principito" />
      </div>
      <div class="cover-illustration" id="defaultCoverIllustration">
        <div class="little-prince">
          <div class="prince-body"></div>
          <div class="prince-scarf"></div>
          <div class="star"></div>
          <div class="star star2"></div>
          <div class="star star3"></div>
        </div>
      </div>
      <h1 class="cover-title">El Principito</h1>
      <p class="cover-author">Antoine de Saint-Exupéry</p>
      
      <div class="cover-upload-section">
        <input type="file" id="coverUpload" accept="image/*" style="display: none;" onchange="handleCoverUpload(event)">
        <button class="upload-cover-btn" onclick="document.getElementById('coverUpload').click()">
          📁 Personalizar Capa
        </button>
        <button class="reset-cover-btn" onclick="resetToDefaultCover()" style="display: none;">
          🔄 Capa Original
        </button>
      </div>
      
      <button class="start-reading-btn" onclick="startReading()">Comenzar Lectura</button>
    </div>
  </div>

  <!-- Header fixo com controles -->
  <div id="bookHeader" class="book-header" style="display: none;">
    <div class="header-left">
      <a href="/index.html" class="back-to-home-btn">🏠 Volver</a>
      <span class="book-title">El Principito</span>
    </div>
    
    <div class="header-center">
      <audio id="audioPlayer" controls preload="auto" controlsList="nodownload">
        <source src="/audio/el-principito.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
      </audio>
    </div>
    
    <div class="header-right">
      <span id="currentChapterDisplay">Cargando...</span>
    </div>
  </div>

  <!-- Contêiner principal do livro -->
  <div id="bookContent" class="book-content" style="display: none;">
    <!-- Floating chapter menu button -->
    <button class="floating-chapters-btn" id="floatingChaptersBtn" onclick="toggleFloatingMenu()">
      📖
    </button>
    
    <!-- Floating menu overlay -->
    <div class="floating-menu-overlay" id="floatingMenuOverlay" onclick="closeFloatingMenu()">
      <div class="floating-menu" id="floatingMenu" onclick="event.stopPropagation()">
        <div class="floating-menu-header">
          <h3>El Principito</h3>
          <button class="floating-menu-close" onclick="closeFloatingMenu()">✕</button>
        </div>
        <div class="floating-menu-content">
          <p class="chapter-count">Cargando capítulos...</p>
          <div class="floating-chapter-list" id="floatingChapterList">
            <div class="loading-chapters">Detectando capítulos...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hover areas for clean reading mode -->
    <div class="audio-hover-area"></div>
    <div class="nav-hover-area"></div>
    
    <div class="book-page-container">
      <!-- O conteúdo será gerado dinamicamente pelo JavaScript -->
      <div class="loading-message">
        <p>Cargando El Principito...</p>
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>

  <!-- Navegação de páginas -->
  <div class="page-navigation" style="display: none;">
    <button id="prevSpread" onclick="wordReader.previousSpread()" disabled>← Anterior</button>
    <span id="spreadIndicator">Cargando...</span>
    <button id="nextSpread" onclick="wordReader.nextSpread()">Siguiente →</button>
  </div>

  <!-- Scripts -->
  <script src="/word-by-word-reader.js"></script>
  <script src="/book-interactions.js"></script>
  
  <script>
    // Load custom cover on page load
    window.addEventListener('load', function() {
      loadCustomCover();
    });

    function loadCustomCover() {
      const savedCover = localStorage.getItem('elPrincipitoCover');
      if (savedCover) {
        const customContainer = document.getElementById('customCoverContainer');
        const customImage = document.getElementById('customCoverImage');
        const defaultIllustration = document.getElementById('defaultCoverIllustration');
        const resetBtn = document.querySelector('.reset-cover-btn');
        
        customImage.src = savedCover;
        customContainer.style.display = 'block';
        defaultIllustration.style.display = 'none';
        resetBtn.style.display = 'inline-block';
      }
    }

    function handleCoverUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Por favor, selecciona un archivo de imagen válido.');
        return;
      }
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('La imagen es demasiado grande. Por favor, selecciona una imagen menor a 5MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const customContainer = document.getElementById('customCoverContainer');
        const customImage = document.getElementById('customCoverImage');
        const defaultIllustration = document.getElementById('defaultCoverIllustration');
        const resetBtn = document.querySelector('.reset-cover-btn');
        
        // Save to localStorage
        localStorage.setItem('elPrincipitoCover', e.target.result);
        
        // Update display
        customImage.src = e.target.result;
        customContainer.style.display = 'block';
        defaultIllustration.style.display = 'none';
        resetBtn.style.display = 'inline-block';
      };
      
      reader.readAsDataURL(file);
    }

    function resetToDefaultCover() {
      localStorage.removeItem('elPrincipitoCover');
      
      const customContainer = document.getElementById('customCoverContainer');
      const defaultIllustration = document.getElementById('defaultCoverIllustration');
      const resetBtn = document.querySelector('.reset-cover-btn');
      
      customContainer.style.display = 'none';
      defaultIllustration.style.display = 'block';
      resetBtn.style.display = 'none';
    }

    function startReading() {
      document.getElementById('bookCover').style.display = 'none';
      document.getElementById('bookContent').style.display = 'block';
      document.getElementById('bookHeader').style.display = 'flex';
      document.querySelector('.page-navigation').style.display = 'flex';
      
      // Inicializar o leitor após mostrar o conteúdo
      setTimeout(() => {
        if (!window.wordReader) {
          initializeWordByWordReader();
        }
      }, 500);
    }
  </script>
</body>
</html>