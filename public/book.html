<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Principito - Libro Interactivo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Georgia', serif;
      line-height: 1.8;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      box-shadow: 0 0 50px rgba(0,0,0,0.3);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .audio-controls {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 2px solid #e9ecef;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #audioPlayer {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: block;
    }

    .controls-help {
      text-align: center;
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }

    .sync-controls {
      text-align: center;
      margin-top: 15px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .sync-controls label {
      font-weight: bold;
      margin-right: 10px;
      color: #856404;
    }

    .sync-controls button {
      background: #667eea;
      color: white;
      border: none;
      padding: 5px 10px;
      margin: 0 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .sync-controls button:hover {
      background: #764ba2;
    }

    .sync-controls span {
      display: inline-block;
      margin: 0 10px;
      font-weight: bold;
      color: #856404;
      min-width: 40px;
    }

    .toc {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
    }

    .toc h2 {
      color: #495057;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .toc ul {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .toc li {
      background: white;
      border-radius: 20px;
      padding: 8px 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .toc a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .toc a:hover {
      color: #764ba2;
    }

    .content {
      padding: 40px;
    }

    .chapter {
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 1px solid #e9ecef;
    }

    .chapter:last-child {
      border-bottom: none;
    }

    .chapter h2 {
      color: #667eea;
      font-size: 1.8em;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
    }

    .line {
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 1.1em;
    }

    .line:hover {
      background: #f8f9fa;
    }

    .line.highlight {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border-left: 4px solid #ffc107;
      transform: translateX(5px);
      box-shadow: 0 2px 10px rgba(255, 193, 7, 0.3);
    }

    .word {
      border-bottom: 1px dotted #667eea;
      cursor: help;
      position: relative;
      padding: 2px;
      border-radius: 3px;
      transition: all 0.2s ease;
    }

    .word:hover {
      background: #e3f2fd;
      border-color: #2196f3;
    }

    .translation-popup {
      position: absolute;
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.9em;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      max-width: 200px;
      word-wrap: break-word;
      display: none;
    }

    .translation-popup::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border: 5px solid transparent;
      border-top-color: #333;
    }

    .progress-bar {
      height: 4px;
      background: #e9ecef;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1001;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .container {
        margin: 0;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2em;
      }
      
      .content {
        padding: 20px;
      }
      
      .toc ul {
        flex-direction: column;
      }
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <div class="container">
    <div class="header">
      <h1>üìñ El Principito</h1>
      <p>Antoine de Saint-Exup√©ry</p>
    </div>

    <div class="audio-controls">
      <audio id="audioPlayer" controls preload="metadata">
        <source src="/audio/el-principito.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
      </audio>
      <div class="controls-help">
        Usa las teclas ‚Üê ‚Üí para navegar ‚Ä¢ Espacio para pausar/reproducir ‚Ä¢ Clica en el texto para ir a ese momento
      </div>
      
      <div class="sync-controls">
        <label>‚öôÔ∏è Ajuste de sincronizaci√≥n:</label>
        <button onclick="app.adjustSync(-5)">-5s</button>
        <button onclick="app.adjustSync(-1)">-1s</button>
        <span id="syncOffset">0s</span>
        <button onclick="app.adjustSync(1)">+1s</button>
        <button onclick="app.adjustSync(5)">+5s</button>
        <button onclick="app.resetSync()">Reset</button>
      </div>
    </div>

    <div class="toc">
      <h2>üìë Sum√°rio</h2>
      <ul id="tocList">
        <!-- TOC ser√° gerado dinamicamente -->
      </ul>
    </div>

    <div class="content" id="bookContent">
      <div class="loading">Cargando el libro...</div>
    </div>
  </div>

  <script>
    class ElPrincipitoInteractive {
      constructor() {
        this.audio = document.getElementById('audioPlayer');
        this.content = document.getElementById('bookContent');
        this.tocList = document.getElementById('tocList');
        this.progressFill = document.getElementById('progressFill');
        this.currentTranslationPopup = null;
        this.syncOffset = 0; // Offset em segundos para ajustar sincroniza√ß√£o
        
        this.initializeAudio();
        this.loadBookContent();
        this.setupKeyboardControls();
        this.setupSelectionTranslation();
      }

      initializeAudio() {
        this.audio.addEventListener('timeupdate', () => {
          this.updateProgress();
          this.highlightCurrentLine();
        });

        this.audio.addEventListener('loadedmetadata', () => {
          console.log('Audio loaded, duration:', this.audio.duration);
        });
      }

      updateProgress() {
        if (this.audio.duration) {
          const progress = (this.audio.currentTime / this.audio.duration) * 100;
          this.progressFill.style.width = progress + '%';
        }
      }

      highlightCurrentLine() {
        const lines = document.querySelectorAll('.line[data-start]');
        const adjustedTime = this.audio.currentTime + this.syncOffset;
        
        // Encontrar a linha mais pr√≥xima do tempo atual (ajustado)
        let closestLine = null;
        let closestDistance = Infinity;
        
        lines.forEach(line => {
          const start = parseFloat(line.dataset.start);
          const end = parseFloat(line.dataset.end);
          
          // Remover highlight de todas as linhas primeiro
          line.classList.remove('highlight');
          
          // Calcular dist√¢ncia do tempo atual para o in√≠cio da linha
          const distance = Math.abs(adjustedTime - start);
          
          // Se estamos dentro do intervalo OU √© a linha mais pr√≥xima
          if ((adjustedTime >= start && adjustedTime <= end) || distance < closestDistance) {
            if (distance < closestDistance) {
              closestDistance = distance;
              closestLine = line;
            }
          }
        });
        
        // Destacar a linha mais pr√≥xima
        if (closestLine && closestDistance < 30) { // Toler√¢ncia de 30 segundos
          closestLine.classList.add('highlight');
          closestLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      adjustSync(seconds) {
        this.syncOffset += seconds;
        document.getElementById('syncOffset').textContent = this.syncOffset + 's';
        // For√ßar atualiza√ß√£o da sincroniza√ß√£o
        this.highlightCurrentLine();
      }

      resetSync() {
        this.syncOffset = 0;
        document.getElementById('syncOffset').textContent = '0s';
        this.highlightCurrentLine();
      }

      setupKeyboardControls() {
        document.addEventListener('keydown', (e) => {
          switch(e.key) {
            case ' ':
              e.preventDefault();
              if (this.audio.paused) {
                this.audio.play();
              } else {
                this.audio.pause();
              }
              break;
            case 'ArrowLeft':
              e.preventDefault();
              this.audio.currentTime = Math.max(0, this.audio.currentTime - 10);
              break;
            case 'ArrowRight':
              e.preventDefault();
              this.audio.currentTime = Math.min(this.audio.duration, this.audio.currentTime + 10);
              break;
          }
        });
      }

      setupSelectionTranslation() {
        document.addEventListener('mouseup', async () => {
          const selection = window.getSelection();
          const selectedText = selection.toString().trim();
          
          if (selectedText && selectedText.length > 1) {
            this.hideTranslationPopup();
            await this.translateSelection(selectedText, selection);
          }
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.translation-popup')) {
            this.hideTranslationPopup();
          }
        });
      }

      async translateSelection(text, selection) {
        try {
          const response = await fetch('/translate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const translation = data.translations[0].text;
          
          this.showTranslationPopup(translation, selection);
        } catch (error) {
          console.error('Translation error:', error);
          this.showTranslationPopup('Error en la traducci√≥n', selection);
        }
      }

      showTranslationPopup(translation, selection) {
        this.hideTranslationPopup();
        
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        const popup = document.createElement('div');
        popup.className = 'translation-popup';
        popup.textContent = translation;
        popup.style.display = 'block';
        popup.style.left = (rect.left + window.scrollX + rect.width / 2) + 'px';
        popup.style.top = (rect.top + window.scrollY - 40) + 'px';
        popup.style.transform = 'translateX(-50%)';
        
        document.body.appendChild(popup);
        this.currentTranslationPopup = popup;
      }

      hideTranslationPopup() {
        if (this.currentTranslationPopup) {
          this.currentTranslationPopup.remove();
          this.currentTranslationPopup = null;
        }
      }

      async loadBookContent() {
        try {
          // Tentar carregar transcri√ß√£o real primeiro
          const response = await fetch('/transcriptions/el-principito.json');
          if (response.ok) {
            const transcription = await response.json();
            this.createContentFromTranscription(transcription);
          } else {
            // Fallback para conte√∫do manual se a transcri√ß√£o n√£o estiver dispon√≠vel
            this.createManualContent();
          }
        } catch (error) {
          console.log('Usando conte√∫do manual:', error);
          this.createManualContent();
        }
      }

      createManualContent() {
        const chapters = [
          {
            id: 'capitulo_1',
            title: 'Cap√≠tulo 1',
            paragraphs: [
              { text: 'Cuando yo ten√≠a seis a√±os vi una vez una magn√≠fica l√°mina en un libro sobre la selva virgen que se llamaba "Historias vividas".', start: 0, end: 8 },
              { text: 'Representaba una serpiente boa que se tragaba a una fiera.', start: 8, end: 14 },
              { text: 'En el libro dec√≠a: "Las serpientes boas se tragan su presa entera, sin masticarla.', start: 14, end: 22 },
              { text: 'Luego no pueden moverse y duermen durante los seis meses que dura su digesti√≥n".', start: 22, end: 30 }
            ]
          },
          {
            id: 'capitulo_2',
            title: 'Cap√≠tulo 2',
            paragraphs: [
              { text: 'As√≠ fue como me encontr√© viviendo solo, sin nadie con quien poder hablar verdaderamente, hasta que hace seis a√±os tuve una aver√≠a en el desierto del Sahara.', start: 30, end: 42 },
              { text: 'Algo se hab√≠a roto en mi motor.', start: 42, end: 46 },
              { text: 'Como no ten√≠a conmigo ni mec√°nico ni pasajeros, me dispuse a realizar, yo solo, una reparaci√≥n dif√≠cil.', start: 46, end: 56 }
            ]
          },
          {
            id: 'capitulo_3',
            title: 'Cap√≠tulo 3',
            paragraphs: [
              { text: 'Necesit√© mucho tiempo para comprender de d√≥nde ven√≠a.', start: 56, end: 62 },
              { text: 'El principito, que me hac√≠a muchas preguntas, jam√°s parec√≠a o√≠r las m√≠as.', start: 62, end: 70 },
              { text: 'Fueron palabras pronunciadas al azar las que, poco a poco, me revelaron todo.', start: 70, end: 78 }
            ]
          },
          {
            id: 'capitulo_4',
            title: 'Cap√≠tulo 4',
            paragraphs: [
              { text: 'As√≠ supe una segunda cosa muy importante: su planeta de origen era apenas m√°s grande que una casa.', start: 78, end: 88 },
              { text: 'Esto no pod√≠a asombrarme mucho.', start: 88, end: 92 },
              { text: 'Sab√≠a muy bien que aparte de los grandes planetas como la Tierra, J√∫piter, Marte, Venus, que tienen nombre, hay centenares de otros que son a veces tan peque√±os que cuesta trabajo distinguirlos con el telescopio.', start: 92, end: 108 }
            ]
          },
          {
            id: 'capitulo_5',
            title: 'Cap√≠tulo 5',
            paragraphs: [
              { text: 'Cada d√≠a yo aprend√≠a algo sobre el planeta, sobre la partida, sobre el viaje.', start: 108, end: 118 },
              { text: 'Esto ven√≠a muy lentamente, al azar de las reflexiones.', start: 118, end: 125 },
              { text: 'As√≠ fue como el tercer d√≠a conoc√≠ el drama de los baobabs.', start: 125, end: 133 }
            ]
          },
          {
            id: 'capitulo_6',
            title: 'Cap√≠tulo 6',
            paragraphs: [
              { text: '¬°Ah, principito! As√≠ fui comprendiendo poco a poco tu peque√±a vida melanc√≥lica.', start: 133, end: 143 },
              { text: 'Durante mucho tiempo tu √∫nica distracci√≥n fue la suavidad de las puestas de sol.', start: 143, end: 152 },
              { text: 'Supe este nuevo detalle la ma√±ana del cuarto d√≠a, cuando me dijiste: ‚ÄîMe gustan mucho las puestas de sol. Vamos a ver una puesta de sol...', start: 152, end: 165 }
            ]
          },
          {
            id: 'capitulo_7',
            title: 'Cap√≠tulo 7',
            paragraphs: [
              { text: 'El quinto d√≠a, siempre gracias al cordero, me fue revelado este secreto de la vida del principito.', start: 165, end: 177 },
              { text: 'Me pregunt√≥ bruscamente, sin pre√°mbulos, como fruto de un problema largamente meditado en silencio: ‚ÄîSi un cordero se come los arbustos, se come tambi√©n las flores, ¬øno?', start: 177, end: 193 },
              { text: '‚ÄîS√≠. Todo lo que encuentra.', start: 193, end: 198 }
            ]
          },
          {
            id: 'capitulo_8',
            title: 'Cap√≠tulo 8',
            paragraphs: [
              { text: 'Pronto conoc√≠ mejor esa flor.', start: 198, end: 204 },
              { text: 'En el planeta del principito hab√≠a siempre habido flores muy simples, adornadas con una sola hilera de p√©talos, que no ocupaban lugar y que no molestaban a nadie.', start: 204, end: 220 },
              { text: 'Aparec√≠an una ma√±ana entre la hierba y se apagaban por la tarde.', start: 220, end: 229 }
            ]
          },
          {
            id: 'capitulo_9',
            title: 'Cap√≠tulo 9',
            paragraphs: [
              { text: 'Creo que aprovech√≥, para su evasi√≥n, una migraci√≥n de p√°jaros silvestres.', start: 229, end: 238 },
              { text: 'La ma√±ana de la partida puso su planeta en perfecto orden.', start: 238, end: 247 },
              { text: 'Deshollin√≥ cuidadosamente sus volcanes en actividad.', start: 247, end: 255 }
            ]
          },
          {
            id: 'capitulo_10',
            title: 'Cap√≠tulo 10',
            paragraphs: [
              { text: 'Se encontraba en la regi√≥n de los asteroides 325, 326, 327, 328, 329 y 330.', start: 255, end: 266 },
              { text: 'Comenz√≥, pues, por visitarlos para buscar una ocupaci√≥n y para instruirse.', start: 266, end: 276 },
              { text: 'El primero estaba habitado por un rey.', start: 276, end: 282 }
            ]
          },
          {
            id: 'capitulo_11',
            title: 'Cap√≠tulo 11',
            paragraphs: [
              { text: 'El segundo planeta estaba habitado por un vanidoso.', start: 282, end: 290 },
              { text: '‚Äî¬°Ah! ¬°Ah! ¬°Un admirador viene a visitarme! ‚Äîgrit√≥ desde lejos el vanidoso en cuanto divis√≥ al principito.', start: 290, end: 304 },
              { text: 'Para los vanidosos todos los dem√°s hombres son admiradores.', start: 304, end: 313 }
            ]
          },
          {
            id: 'capitulo_12',
            title: 'Cap√≠tulo 12',
            paragraphs: [
              { text: 'El planeta siguiente estaba habitado por un bebedor.', start: 313, end: 321 },
              { text: 'Esta visita fue muy corta, pero sumi√≥ al principito en una gran melancol√≠a.', start: 321, end: 332 },
              { text: '‚Äî¬øQu√© haces ah√≠? ‚Äîle dijo al bebedor, a quien encontr√≥ instalado en silencio ante una colecci√≥n de botellas vac√≠as y una colecci√≥n de botellas llenas.', start: 332, end: 349 }
            ]
          },
          {
            id: 'capitulo_13',
            title: 'Cap√≠tulo 13',
            paragraphs: [
              { text: 'El cuarto planeta era el del hombre de negocios.', start: 349, end: 356 },
              { text: 'Este hombre estaba tan absorto que ni siquiera levant√≥ la cabeza a la llegada del principito.', start: 356, end: 368 },
              { text: '‚ÄîBuenos d√≠as ‚Äîle dijo √©ste‚Äî. Su cigarro se ha apagado.', start: 368, end: 376 }
            ]
          },
          {
            id: 'capitulo_14',
            title: 'Cap√≠tulo 14',
            paragraphs: [
              { text: 'El quinto planeta era muy curioso.', start: 376, end: 382 },
              { text: 'Era el m√°s peque√±o de todos.', start: 382, end: 388 },
              { text: 'Hab√≠a en √©l lugar justo para un farol y un farolero.', start: 388, end: 397 }
            ]
          },
          {
            id: 'capitulo_15',
            title: 'Cap√≠tulo 15',
            paragraphs: [
              { text: 'El sexto planeta era diez veces m√°s vasto.', start: 397, end: 405 },
              { text: 'Estaba habitado por un anciano que escrib√≠a enormes libros.', start: 405, end: 414 },
              { text: '‚Äî¬°Tiens! ¬°Un explorador! ‚Äîexclam√≥ cuando divis√≥ al principito.', start: 414, end: 423 }
            ]
          },
          {
            id: 'capitulo_16',
            title: 'Cap√≠tulo 16',
            paragraphs: [
              { text: 'El s√©ptimo planeta fue, por consiguiente, la Tierra.', start: 423, end: 431 },
              { text: '¬°La Tierra no es un planeta cualquiera!', start: 431, end: 438 },
              { text: 'Se cuentan en ella ciento once reyes (sin olvidar, naturalmente, los reyes negros), siete mil ge√≥grafos, novecientos mil hombres de negocios, siete millones y medio de borrachos, trescientos once millones de vanidosos, es decir, alrededor de dos mil millones de personas mayores.', start: 438, end: 468 }
            ]
          },
          {
            id: 'capitulo_17',
            title: 'Cap√≠tulo 17',
            paragraphs: [
              { text: 'Cuando uno quiere ser ingenioso a veces miente un poco.', start: 468, end: 476 },
              { text: 'No he sido muy honesto al hablaros de los faroleros.', start: 476, end: 484 },
              { text: 'Corro el riesgo de dar una falsa idea de nuestro planeta a quienes no lo conocen.', start: 484, end: 495 }
            ]
          },
          {
            id: 'capitulo_18',
            title: 'Cap√≠tulo 18',
            paragraphs: [
              { text: 'El principito atraves√≥ el desierto y no encontr√≥ m√°s que una flor.', start: 495, end: 504 },
              { text: 'Una flor de tres p√©talos, una flor de nada...', start: 504, end: 511 },
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo el principito.', start: 511, end: 517 }
            ]
          },
          {
            id: 'capitulo_19',
            title: 'Cap√≠tulo 19',
            paragraphs: [
              { text: 'El principito escal√≥ hasta la cima de una alta monta√±a.', start: 517, end: 526 },
              { text: 'Las √∫nicas monta√±as que hab√≠a conocido eran los tres volcanes que le llegaban a la rodilla.', start: 526, end: 537 },
              { text: 'Y utilizaba el volc√°n apagado como taburete.', start: 537, end: 544 }
            ]
          },
          {
            id: 'capitulo_20',
            title: 'Cap√≠tulo 20',
            paragraphs: [
              { text: 'Pero sucedi√≥ que el principito, habiendo caminado largo tiempo a trav√©s de arenas, de rocas y de nieves, descubri√≥ finalmente un camino.', start: 544, end: 558 },
              { text: 'Y todos los caminos van hacia los hombres.', start: 558, end: 565 },
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo.', start: 565, end: 569 }
            ]
          },
          {
            id: 'capitulo_21',
            title: 'Cap√≠tulo 21',
            paragraphs: [
              { text: 'Fue entonces cuando apareci√≥ el zorro.', start: 569, end: 575 },
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo el zorro.', start: 575, end: 580 },
              { text: '‚ÄîBuenos d√≠as ‚Äîrespondi√≥ cort√©smente el principito, que se dio vuelta, pero no vio nada.', start: 580, end: 591 }
            ]
          },
          {
            id: 'capitulo_22',
            title: 'Cap√≠tulo 22',
            paragraphs: [
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo el principito.', start: 591, end: 597 },
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo el guardaagujas.', start: 597, end: 603 },
              { text: '‚Äî¬øQu√© haces aqu√≠? ‚Äîdijo el principito.', start: 603, end: 610 }
            ]
          },
          {
            id: 'capitulo_23',
            title: 'Cap√≠tulo 23',
            paragraphs: [
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo el principito.', start: 610, end: 616 },
              { text: '‚ÄîBuenos d√≠as ‚Äîdijo el mercader.', start: 616, end: 622 },
              { text: 'Era un mercader de p√≠ldoras perfeccionadas que apagan la sed.', start: 622, end: 632 }
            ]
          },
          {
            id: 'capitulo_24',
            title: 'Cap√≠tulo 24',
            paragraphs: [
              { text: 'Era el octavo d√≠a de mi panne en el desierto, y hab√≠a escuchado la historia del mercader mientras beb√≠a la √∫ltima gota de mi provisi√≥n de agua.', start: 632, end: 648 },
              { text: '‚Äî¬°Ah! ‚Äîle dije al principito‚Äî. Muy lindos son tus recuerdos, pero yo no he reparado a√∫n mi avi√≥n, no tengo m√°s agua para beber, y ser√≠a feliz si pudiera caminar lentamente hacia una fuente.', start: 648, end: 668 },
              { text: '‚ÄîMi amigo el zorro ‚Äîme dijo...', start: 668, end: 674 }
            ]
          },
          {
            id: 'capitulo_25',
            title: 'Cap√≠tulo 25',
            paragraphs: [
              { text: '‚ÄîLos hombres ‚Äîdijo el principito‚Äî se meten en los r√°pidos, pero no saben ad√≥nde van ni lo que quieren.', start: 674, end: 687 },
              { text: 'Entonces se agitan y dan vueltas...', start: 687, end: 694 },
              { text: 'Y a√±adi√≥: ‚ÄîNo vale la pena...', start: 694, end: 700 }
            ]
          },
          {
            id: 'capitulo_26',
            title: 'Cap√≠tulo 26',
            paragraphs: [
              { text: 'Al lado del pozo hab√≠a una ruina de viejo muro de piedra.', start: 700, end: 709 },
              { text: 'Cuando regres√© de mi trabajo, a la tarde siguiente, vi desde lejos a mi principito sentado all√≠ arriba, con las piernas colgando.', start: 709, end: 724 },
              { text: 'Y le o√≠ que hablaba.', start: 724, end: 729 }
            ]
          },
          {
            id: 'capitulo_27',
            title: 'Cap√≠tulo 27',
            paragraphs: [
              { text: 'Y ahora, ciertamente, han pasado ya seis a√±os...', start: 729, end: 737 },
              { text: 'Jam√°s he contado esta historia.', start: 737, end: 743 },
              { text: 'Los compa√±eros que me han encontrado se han alegrado mucho de verme vivo.', start: 743, end: 753 }
            ]
          }
        ];

        // Generate TOC
        let tocHTML = '';
        chapters.forEach(chapter => {
          tocHTML += `<li><a href="#${chapter.id}" onclick="app.scrollToChapter('${chapter.id}')">${chapter.title}</a></li>`;
        });
        this.tocList.innerHTML = tocHTML;

        // Generate content
        let contentHTML = '';
        chapters.forEach(chapter => {
          contentHTML += `
            <div class="chapter" id="${chapter.id}">
              <h2>${chapter.title}</h2>
          `;
          
          chapter.paragraphs.forEach(para => {
            contentHTML += `
              <p class="line" data-start="${para.start}" data-end="${para.end}" onclick="app.seekToTime(${para.start})">
                ${this.addWordTranslations(para.text)}
              </p>
            `;
          });
          
          contentHTML += '</div>';
        });

        this.content.innerHTML = contentHTML;
      }

      createContentFromTranscription(transcription) {
        const segments = transcription.segments;
        const chapters = {};
        let currentChapter = null;

        // Agrupar segmentos por cap√≠tulos
        segments.forEach(segment => {
          if (segment.text.startsWith('Cap√≠tulo')) {
            currentChapter = {
              id: segment.text.toLowerCase().replace(/[^a-z0-9]/g, '-'),
              title: segment.text,
              paragraphs: []
            };
            chapters[currentChapter.id] = currentChapter;
          } else if (currentChapter) {
            currentChapter.paragraphs.push({
              text: segment.text,
              start: segment.start,
              end: segment.end
            });
          }
        });

        // Gerar TOC
        let tocHTML = '';
        Object.values(chapters).forEach(chapter => {
          tocHTML += `<li><a href="#${chapter.id}" onclick="app.scrollToChapter('${chapter.id}')">${chapter.title}</a></li>`;
        });
        this.tocList.innerHTML = tocHTML;

        // Gerar conte√∫do
        let contentHTML = '';
        Object.values(chapters).forEach(chapter => {
          contentHTML += `
            <div class="chapter" id="${chapter.id}">
              <h2>${chapter.title}</h2>
          `;
          
          chapter.paragraphs.forEach(para => {
            contentHTML += `
              <p class="line" data-start="${para.start}" data-end="${para.end}" onclick="app.seekToTime(${para.start})">
                ${this.addWordTranslations(para.text)}
              </p>
            `;
          });
          
          contentHTML += '</div>';
        });

        this.content.innerHTML = contentHTML;
      }

      addWordTranslations(text) {
        // Palavras importantes com tradu√ß√µes em portugu√™s
        const translations = {
          'serpiente': 'cobra',
          'selva': 'selva/floresta',
          'desierto': 'deserto',
          'motor': 'motor',
          'reparaci√≥n': 'reparo/conserto',
          'mec√°nico': 'mec√¢nico',
          'pasajeros': 'passageiros',
          'aver√≠a': 'pane/defeito'
        };

        let result = text;
        Object.keys(translations).forEach(word => {
          const regex = new RegExp(`\\b${word}\\b`, 'gi');
          result = result.replace(regex, `<span class="word" title="${translations[word]}">$&</span>`);
        });

        return result;
      }

      scrollToChapter(chapterId) {
        const chapter = document.getElementById(chapterId);
        if (chapter) {
          chapter.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      seekToTime(time) {
        this.audio.currentTime = time;
        if (this.audio.paused) {
          this.audio.play();
        }
      }
    }

    // Initialize the app
    const app = new ElPrincipitoInteractive();
  </script>
</body>
</html>